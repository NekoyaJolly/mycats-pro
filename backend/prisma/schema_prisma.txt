// Prisma Schema - Last Updated: 2025-10-01T19:43:09.854Z
// Auto-generated from schema.prisma

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// 自動同期テスト - 2025年8月9日

generator client {
  provider   = "prisma-client-js"
  engineType = "library"    // ← Node-API を明示
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  clerkId     String   @unique @map("clerk_id")
  email       String   @unique
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  role        UserRole @default(USER)
  isActive    Boolean  @default(true) @map("is_active")
  passwordHash String? @map("password_hash")
  refreshToken String?  @map("refresh_token") // JWT refresh token storage
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil DateTime? @map("locked_until")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  cats        Cat[]
  breedingRecords BreedingRecord[]
  careRecords     CareRecord[]
  schedules       Schedule[]
  loginAttempts   LoginAttempt[]

  @@map("users")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  email     String
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  success   Boolean
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_attempts")
}

model Breed {
  id          String   @id @default(uuid())
  code        Int      @unique // キー from CSV
  name        String   @unique // 種類名称 from CSV
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  cats        Cat[]
  pedigrees   Pedigree[]

  @@map("breeds")
}

model CoatColor {
  id          String   @id @default(uuid())
  code        Int      @unique // キー from CSV
  name        String   @unique // 毛色名称 from CSV
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  cats        Cat[]
  pedigrees   Pedigree[]

  @@map("coat_colors")
}

model Cat {
  id              String    @id @default(uuid())
  registrationId  String    @unique @map("registration_id")
  name            String
  
  // Updated breed and color relations
  breedId         String?   @map("breed_id")
  breed           Breed?    @relation(fields: [breedId], references: [id])
  colorId         String?   @map("color_id")
  color           CoatColor? @relation(fields: [colorId], references: [id])
  
  // Legacy fields for backward compatibility
  legacyBreed     String?   @map("legacy_breed") // Old breed field
  legacyColor     String?   @map("legacy_color") // Old color field
  
  pattern         String?
  gender          Gender
  birthDate       DateTime  @map("birth_date")
  weight          Float?
  microchipId     String?   @unique @map("microchip_id")
  isActive        Boolean   @default(true) @map("is_active")
  notes           String?
  imageUrl        String?   @map("image_url")
  
  // Parent information
  fatherId        String?   @map("father_id")
  motherId        String?   @map("mother_id")
  father          Cat?      @relation("CatFather", fields: [fatherId], references: [id])
  mother          Cat?      @relation("CatMother", fields: [motherId], references: [id])
  
  // Children relations
  fatherOf        Cat[]     @relation("CatFather")
  motherOf        Cat[]     @relation("CatMother")
  
  // Owner
  ownerId         String    @map("owner_id")
  owner           User      @relation(fields: [ownerId], references: [id])
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  maleBreedingRecords   BreedingRecord[] @relation("MaleBreeding")
  femaleBreedingRecords BreedingRecord[] @relation("FemaleBreeding")
  careRecords     CareRecord[]
  schedules       Schedule[]
  tags            CatTag[]
  pedigrees       Pedigree[]

  @@map("cats")
}

model BreedingRecord {
  id          String   @id @default(uuid())
  maleId      String   @map("male_id")
  femaleId    String   @map("female_id")
  breedingDate DateTime @map("breeding_date")
  expectedDueDate DateTime? @map("expected_due_date")
  actualDueDate   DateTime? @map("actual_due_date")
  numberOfKittens Int? @map("number_of_kittens")
  notes       String?
  status      BreedingStatus @default(PLANNED)
  
  male        Cat      @relation("MaleBreeding", fields: [maleId], references: [id])
  female      Cat      @relation("FemaleBreeding", fields: [femaleId], references: [id])
  
  recordedBy  String  @map("recorded_by")
  recorder    User     @relation(fields: [recordedBy], references: [id])
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("breeding_records")
}

model CareRecord {
  id          String   @id @default(uuid())
  catId       String   @map("cat_id")
  careType    CareType @map("care_type")
  description String
  careDate    DateTime @map("care_date")
  nextDueDate DateTime? @map("next_due_date")
  cost        Float?
  veterinarian String?
  notes       String?
  
  cat         Cat      @relation(fields: [catId], references: [id])
  
  recordedBy  String  @map("recorded_by")
  recorder    User     @relation(fields: [recordedBy], references: [id])
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("care_records")
}

model Schedule {
  id          String        @id @default(uuid())
  title       String
  description String?
  scheduleDate DateTime @map("schedule_date")
  scheduleType ScheduleType @map("schedule_type")
  status      ScheduleStatus @default(PENDING)
  priority    Priority      @default(MEDIUM)
  
  // Optional cat relation
  catId       String?  @map("cat_id")
  cat         Cat?          @relation(fields: [catId], references: [id])
  
  assignedTo  String  @map("assigned_to")
  assignee    User          @relation(fields: [assignedTo], references: [id])
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("schedules")
}

model Tag {
  id          String   @id @default(uuid())
  name        String   @unique
  color       String   @default("#3B82F6")
  description String?
  
  cats        CatTag[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("tags")
}

model Pedigree {
  id                    String    @id @default(uuid())
  pedigreeId            String    @unique @map("pedigree_id") // PedigreeID from CSV
  
  // Cat information
  catId                 String?   @map("cat_id")
  cat                   Cat?      @relation(fields: [catId], references: [id])
  
  // Names (multiple parts)
  title                 String?   // Title from CSV
  catName               String    @map("cat_name") // CatName from CSV (column 3)
  catName2              String?   @map("cat_name2") // CatName2 from CSV (column 4)
  
  // Basic info
  breedId               String?   @map("breed_id")
  breed                 Breed?    @relation(fields: [breedId], references: [id])
  breedCode             Int?      @map("breed_code") // 猫種コード
  gender                Int?      // 性別 (1=male, 2=female)
  eyeColor              String?   @map("eye_color") // 目色
  colorId               String?   @map("color_id")
  color                 CoatColor? @relation(fields: [colorId], references: [id])
  coatColorCode         Int?      @map("coat_color_code") // 毛色コード
  
  // Dates
  birthDate             DateTime? @map("birth_date") // 生年月日
  registrationDate      DateTime? @map("registration_date") // 登録年月日
  pedigreeIssueDate     DateTime? @map("pedigree_issue_date") // 血統書発行日
  
  // People
  breederName           String?   @map("breeder_name") // 繁殖者名
  ownerName             String?   @map("owner_name") // 所有者名
  
  // Siblings
  brotherCount          Int?      @map("brother_count") // 兄弟の人数
  sisterCount           Int?      @map("sister_count") // 姉妹の人数
  
  // Notes and other info
  notes                 String?   // 摘要
  notes2                String?   // 摘要２
  otherNo               String?   @map("other_no") // 他団体No
  oldCode               String?   @map("old_code") // 旧コード
  
  // Parent relations
  fatherPedigreeId      String?   @map("father_pedigree_id")
  fatherPedigree        Pedigree? @relation("PedigreeFather", fields: [fatherPedigreeId], references: [id])
  fatherOf              Pedigree[] @relation("PedigreeFather")
  
  motherPedigreeId      String?   @map("mother_pedigree_id")
  motherPedigree        Pedigree? @relation("PedigreeMother", fields: [motherPedigreeId], references: [id])
  motherOf              Pedigree[] @relation("PedigreeMother")
  
  // Grandparent relations
  paternalGrandfatherId String?   @map("paternal_grandfather_id")
  paternalGrandfather   Pedigree? @relation("PatGrandfather", fields: [paternalGrandfatherId], references: [id])
  paternalGrandfatherOf Pedigree[] @relation("PatGrandfather")
  
  paternalGrandmotherId String?   @map("paternal_grandmother_id")
  paternalGrandmother   Pedigree? @relation("PatGrandmother", fields: [paternalGrandmotherId], references: [id])
  paternalGrandmotherOf Pedigree[] @relation("PatGrandmother")
  
  maternalGrandfatherId String?   @map("maternal_grandfather_id")
  maternalGrandfather   Pedigree? @relation("MatGrandfather", fields: [maternalGrandfatherId], references: [id])
  maternalGrandfatherOf Pedigree[] @relation("MatGrandfather")
  
  maternalGrandmotherId String?   @map("maternal_grandmother_id")
  maternalGrandmother   Pedigree? @relation("MatGrandmother", fields: [maternalGrandmotherId], references: [id])
  maternalGrandmotherOf Pedigree[] @relation("MatGrandmother")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("pedigrees")
}

model CatTag {
  catId       String   @map("cat_id")
  tagId       String   @map("tag_id")
  
  cat         Cat      @relation(fields: [catId], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@id([catId, tagId])
  @@map("cat_tags")
}

// Enums
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Gender {
  MALE
  FEMALE
}

enum BreedingStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum CareType {
  VACCINATION
  HEALTH_CHECK
  GROOMING
  DENTAL_CARE
  MEDICATION
  SURGERY
  OTHER
}

enum ScheduleType {
  BREEDING
  CARE
  APPOINTMENT
  REMINDER
  MAINTENANCE
}

enum ScheduleStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
